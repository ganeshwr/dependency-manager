<template>
  <div class="fixed inset-0 z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
      <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" @click="$emit('close')"></div>

      <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full">
        <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
          <div class="sm:flex sm:items-start">
            <div class="mt-3 text-center sm:mt-0 sm:text-left w-full">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">
                  Vulnerability Details
                </h3>
                <button
                  @click="$emit('close')"
                  class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200"
                >
                  <X class="w-6 h-6" />
                </button>
              </div>

              <div class="space-y-6">
                <!-- Header Info -->
                <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                  <div class="flex items-center justify-between mb-2">
                    <h4 class="text-lg font-semibold text-gray-900 dark:text-white">
                      {{ vulnerability.cve }}
                    </h4>
                    <span :class="getSeverityBadgeClass(vulnerability.severity)" class="status-badge">
                      {{ vulnerability.severity }}
                    </span>
                  </div>
                  <p class="text-sm text-gray-600 dark:text-gray-400">
                    Affects: {{ vulnerability.packageName }} {{ vulnerability.packageVersion }}
                  </p>
                </div>

                <!-- Title and Description -->
                <div>
                  <h5 class="text-sm font-medium text-gray-900 dark:text-white mb-2">Title</h5>
                  <p class="text-sm text-gray-700 dark:text-gray-300">{{ vulnerability.title }}</p>
                </div>

                <div>
                  <h5 class="text-sm font-medium text-gray-900 dark:text-white mb-2">Description</h5>
                  <p class="text-sm text-gray-700 dark:text-gray-300">{{ vulnerability.description }}</p>
                </div>

                <!-- Details Grid -->
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <h5 class="text-sm font-medium text-gray-900 dark:text-white mb-2">Published Date</h5>
                    <p class="text-sm text-gray-700 dark:text-gray-300">{{ formatDate(vulnerability.publishedDate) }}</p>
                  </div>

                  <div>
                    <h5 class="text-sm font-medium text-gray-900 dark:text-white mb-2">Fixed Version</h5>
                    <p class="text-sm text-gray-700 dark:text-gray-300">
                      {{ vulnerability.fixedVersion || 'No fix available' }}
                    </p>
                  </div>
                </div>

                <!-- CVSS Score (Mock) -->
                <div>
                  <h5 class="text-sm font-medium text-gray-900 dark:text-white mb-2">CVSS Score</h5>
                  <div class="flex items-center space-x-4">
                    <div class="flex-1 bg-gray-200 dark:bg-gray-600 rounded-full h-2">
                      <div 
                        :class="getCvssBarClass(vulnerability.severity)"
                        class="h-2 rounded-full transition-all duration-300"
                        :style="{ width: getCvssWidth(vulnerability.severity) }"
                      ></div>
                    </div>
                    <span class="text-sm font-medium text-gray-900 dark:text-white">
                      {{ getCvssScore(vulnerability.severity) }}
                    </span>
                  </div>
                </div>

                <!-- References (Mock) -->
                <div>
                  <h5 class="text-sm font-medium text-gray-900 dark:text-white mb-2">References</h5>
                  <div class="space-y-2">
                    <a
                      href="#"
                      class="flex items-center text-sm text-primary-600 hover:text-primary-800 dark:text-primary-400 dark:hover:text-primary-300"
                    >
                      <ExternalLink class="w-4 h-4 mr-2" />
                      National Vulnerability Database
                    </a>
                    <a
                      href="#"
                      class="flex items-center text-sm text-primary-600 hover:text-primary-800 dark:text-primary-400 dark:hover:text-primary-300"
                    >
                      <ExternalLink class="w-4 h-4 mr-2" />
                      GitHub Security Advisory
                    </a>
                  </div>
                </div>

                <!-- Remediation -->
                <div v-if="vulnerability.fixedVersion">
                  <h5 class="text-sm font-medium text-gray-900 dark:text-white mb-2">Remediation</h5>
                  <div class="bg-green-50 dark:bg-green-900 border border-green-200 dark:border-green-700 rounded-lg p-4">
                    <div class="flex items-start">
                      <CheckCircle class="w-5 h-5 text-green-600 dark:text-green-400 mt-0.5 mr-3" />
                      <div>
                        <p class="text-sm text-green-800 dark:text-green-200">
                          Update {{ vulnerability.packageName }} to version {{ vulnerability.fixedVersion }} or later to fix this vulnerability.
                        </p>
                        <div class="mt-3">
                          <code class="bg-green-100 dark:bg-green-800 text-green-800 dark:text-green-200 px-2 py-1 rounded text-xs">
                            npm update {{ vulnerability.packageName }}@{{ vulnerability.fixedVersion }}
                          </code>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div v-else>
                  <h5 class="text-sm font-medium text-gray-900 dark:text-white mb-2">Remediation</h5>
                  <div class="bg-yellow-50 dark:bg-yellow-900 border border-yellow-200 dark:border-yellow-700 rounded-lg p-4">
                    <div class="flex items-start">
                      <AlertTriangle class="w-5 h-5 text-yellow-600 dark:text-yellow-400 mt-0.5 mr-3" />
                      <p class="text-sm text-yellow-800 dark:text-yellow-200">
                        No fix is currently available for this vulnerability. Consider using an alternative package or implementing additional security measures.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
          <button
            v-if="vulnerability.fixedVersion"
            @click="applyFix"
            type="button"
            class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 sm:ml-3 sm:w-auto sm:text-sm"
          >
            Apply Fix
          </button>
          <button
            @click="$emit('close')"
            type="button"
            class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-700 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 sm:mt-0 sm:w-auto sm:text-sm"
          >
            Close
          </button>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { format } from 'date-fns'
import { useToastStore } from '../../stores/toast'
import {
  X,
  ExternalLink,
  CheckCircle,
  AlertTriangle
} from 'lucide-vue-next'

interface Props {
  vulnerability: any
}

const props = defineProps<Props>()
const emit = defineEmits<{
  close: []
}>()

const toastStore = useToastStore()

const getSeverityBadgeClass = (severity: string) => {
  const classes = {
    critical: 'status-critical',
    high: 'status-high',
    medium: 'status-medium',
    low: 'status-low'
  }
  return classes[severity as keyof typeof classes] || 'status-unknown'
}

const getCvssScore = (severity: string) => {
  const scores = {
    critical: '9.0',
    high: '7.5',
    medium: '5.0',
    low: '2.5'
  }
  return scores[severity as keyof typeof scores] || '0.0'
}

const getCvssWidth = (severity: string) => {
  const widths = {
    critical: '90%',
    high: '75%',
    medium: '50%',
    low: '25%'
  }
  return widths[severity as keyof typeof widths] || '0%'
}

const getCvssBarClass = (severity: string) => {
  const classes = {
    critical: 'bg-red-500',
    high: 'bg-orange-500',
    medium: 'bg-yellow-500',
    low: 'bg-green-500'
  }
  return classes[severity as keyof typeof classes] || 'bg-gray-500'
}

const formatDate = (date: Date) => {
  return format(date, 'MMMM d, yyyy')
}

const applyFix = () => {
  toastStore.info('Applying Fix', `Updating ${props.vulnerability.packageName} to ${props.vulnerability.fixedVersion}`)
  setTimeout(() => {
    toastStore.success('Fix Applied', `${props.vulnerability.packageName} has been updated successfully`)
    emit('close')
  }, 1500)
}
</script>